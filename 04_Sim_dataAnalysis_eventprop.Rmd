---
title: "04_Sim_dataAnalysis_eventNum"
author: "Yufang Wang"
date: "2025-03-18"
output: pdf_document
---

# Step 1: Set up the environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
setwd("C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#G:/MasterThesis/Code/"
install_and_load <- function(packages) {
  for (pkg in packages) {
    if (!require(pkg, character.only = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
    }
    library(pkg, character.only = TRUE) }
  
}

# List of required packages
required_packages <- c("rstan", "MASS", "rstantools", "coda", "readr", "survival", "splines2", "dplyr", "simsurv", "Hmisc", "caret")
# Install and/or load packages
install_and_load(required_packages)


source("./function_file/Functions.R")
source("./function_file/stan_constructor.R")
```


# Step 2: Generate simulated data
```{r, echo=TRUE}
simulation_bayint_survival <- function(
  criteria = c("DesignCoefficients", "baseline", "variableSelection", "Prediction_SurvivalProb"),
  withPrediction = FALSE,
  event_props = c(0.1, 0.4, 0.5),
  n_sample = 200,
  n_features = 10
) {
  output <- list()
  
  # Generate data
  simulated_data <-
    DataGenerator(n_samples = n_sample, n_features = n_features)
  dataset <- simulated_data$dataset
  Beta <- simulated_data$Beta
  output$Beta_true <- Beta
  for (event_prop in event_props) {
    print(event_prop)

    # Apply censoring to achieve desired event proportion
    n_events <- round(event_prop * n_sample)
    event_ids <- sample(dataset$id, size = n_events)
    dataset$status <- ifelse(dataset$id %in% event_ids, 1, 0)

    # Adjust observed times for censored individuals
    dataset$obstime <- ifelse(dataset$status == 0,
                               runif(sum(dataset$status == 0), 0, dataset$eventtime),
                               dataset$eventtime)
    dataset_ <- dataset[, !(names(dataset) %in% c("eventtime"))]

    output[[paste0("NumTied_", event_prop)]] <- length(dataset$obstime) - length(unique(dataset$obstime))

    # Split data if prediction is required
    if (withPrediction) {
      samples <- sample(1:nrow(dataset_), 100)
      training_dataset <- dataset_[-samples, ]
      testing_dataset <- dataset_[samples, ]
    } else {
      training_dataset <- dataset_
      testing_dataset <- NULL
    }

    # Construct data for models
    stan_data_PH <- stan_data_Constructer_PH(training_dataset, testing_dataset)
    stan_data_bSplines <- stan_data_Constructer_BSpline(training_dataset, testing_dataset, obs_window = 5)

    # Fit Bayesian models
    model_fit_bSplines <- Bayesian_Survival_model(stan_data_bSplines, baseline_modelling = "bSplines", shrinkage = TRUE, withPrediction = withPrediction)
    model_fit_PH <- Bayesian_Survival_model(stan_data_PH, baseline_modelling = "none", shrinkage = TRUE, withPrediction = withPrediction)

    # Diagnostics
    output[[paste0("diagnostics_bSplines_", event_prop)]] <- summary(model_fit_bSplines)$summary[, c("Rhat", "n_eff")]
    output[[paste0("diagnostics_PH_", event_prop)]] <- summary(model_fit_PH)$summary[, c("Rhat", "n_eff")]

    # Extract results
    result_bSplines <- Bayesian_Survival_result_Extract(model_fit_bSplines, "bSplines", criteria)
    result_PH <- Bayesian_Survival_result_Extract(model_fit_PH, "none", criteria)

    if ("DesignCoefficients" %in% criteria) {
      output[[paste0("Beta_bSplines_", event_prop)]] <- result_bSplines$Beta_bayesian_est[, "mean"]
      output[[paste0("Beta_PH_", event_prop)]] <- result_PH$Beta_bayesian_est[, "mean"]
    }

    if ("baseline" %in% criteria) {
      time_vec <- sort(training_dataset[training_dataset$status == 1, ]$obstime)
      output[[paste0("time_vec_", event_prop)]] <- time_vec
      output[[paste0("baseline_true_", event_prop)]] <- 10 * 2 * (time_vec ^ (10 - 1))
      output[[paste0("baseline_bSplines_", event_prop)]] <- exp(as.matrix(stan_data_bSplines$basis) %*% result_bSplines$baselinePara[, "mean"])
    }

    if ("variableSelection" %in% criteria) {
      output[[paste0("varSel_bSplines_", event_prop)]] <- result_bSplines$variableSelection
      output[[paste0("varSel_PH_", event_prop)]] <- result_PH$variableSelection
    }

    if ("Prediction_SurvivalProb" %in% criteria && withPrediction) {
      output[[paste0("time_", event_prop)]] <- testing_dataset$obstime
      output[[paste0("true_status_", event_prop)]] <- testing_dataset$status
      output[[paste0("eta_true_", event_prop)]] <- as.vector(
        as.matrix(stan_data_bSplines$x_new) %*% Beta[1:10] +
        as.matrix(stan_data_bSplines$x_int_new) %*% Beta[11:55]
      )
      output[[paste0("eta_pred_bSplines_", event_prop)]] <- result_bSplines$eta_pred
      output[[paste0("eta_pred_PH_", event_prop)]] <- result_PH$eta_pred
    }
  }
  return(output)
}
replicate_times = 50

simulated_results = replicate(replicate_times, simulation_bayint_survival())
save.image(file = "./Data/sim_50_para_nsamples.RData")
```


```{r, echo=TRUE}
load(file = "./Data/sim_50_para_event_prop_200.RData")
Beta_true = rep(NA, 55)
NumTied_0.1 = rep(NA, replicate_times)
NumTied_0.4 = rep(NA, replicate_times)
NumTied_0.9 = rep(NA, replicate_times)

diagnostics_bSplines_0.1 = matrix(160, replicate_times)
diagnostics_bSplines_0.4 = matrix(160, replicate_times)
diagnostics_bSplines_0.9 = matrix(160, replicate_times)

diagnostics_PH_0.1 = matrix(154, replicate_times)
diagnostics_PH_0.4 = matrix(154, replicate_times)
diagnostics_PH_0.9 = matrix(154, replicate_times)


Beta_est_bSplines_0.1 = matrix(nrow = replicate_times, ncol = 55)
Beta_est_bSplines_0.4 = matrix(nrow = replicate_times, ncol = 55)
Beta_est_bSplines_0.9 = matrix(nrow = replicate_times, ncol = 55)

Beta_est_PH_0.1 = matrix(nrow = replicate_times, ncol = 55)
Beta_est_PH_0.4 = matrix(nrow = replicate_times, ncol = 55)
Beta_est_PH_0.9 = matrix(nrow = replicate_times, ncol = 55)


time_vec_0.1 = matrix(50, replicate_times)
time_vec_0.4 = matrix(50, replicate_times)
time_vec_0.9 = matrix(50, replicate_times)

baseline_true_0.1 = matrix(50, replicate_times)
baseline_true_0.4 = matrix(50, replicate_times)
baseline_true_0.9 = matrix(50, replicate_times)

baseline_bSplines_0.1 = matrix(50, replicate_times)
baseline_bSplines_0.4 = matrix(50, replicate_times)
baseline_bSplines_0.9 = matrix(50, replicate_times)


varSel_bSplines_0.1 =  matrix(nrow = replicate_times, ncol = 55)
varSel_bSplines_0.4 =  matrix(nrow = replicate_times, ncol = 55)
varSel_bSplines_0.9 =  matrix(nrow = replicate_times, ncol = 55)

varSel_PH_0.1 = matrix(nrow = replicate_times, ncol = 55)
varSel_PH_0.4 =  matrix(nrow = replicate_times, ncol = 55)
varSel_PH_0.9 =  matrix(nrow = replicate_times, ncol = 55)

# Bias  
Bias_bSplines_0.1 = rep(NA, ncol = 55)
Bias_bSplines_0.4 = rep(NA, ncol = 55)
Bias_bSplines_0.9 = rep(NA, ncol = 55)
Bias_PH_0.1 = rep(NA, ncol = 55)
Bias_PH_0.4 = rep(NA, ncol = 55)
Bias_PH_0.9 = rep(NA, ncol = 55)


# MSE
MSEs_bSplines_0.1_ = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines_0.4_ = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines_0.9_ = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH_0.1_ = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH_0.4_ = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH_0.9_ = matrix(nrow = replicate_times, ncol = 55)

# Type I error
FDR_bSplines_0.1 = rep(NA, replicate_times)
FDR_bSplines_0.4 = rep(NA, replicate_times)
FDR_bSplines_0.9 = rep(NA, replicate_times)
FDR_PH_0.1 = rep(NA, replicate_times)
FDR_PH_0.4 = rep(NA, replicate_times)
FDR_PH_0.9 = rep(NA, replicate_times)

# Type II error
FNR_bSplines_0.1 = rep(NA, replicate_times)
FNR_bSplines_0.4 = rep(NA, replicate_times)
FNR_bSplines_0.9 = rep(NA, replicate_times)
FNR_PH_0.1 = rep(NA, replicate_times)
FNR_PH_0.4 = rep(NA, replicate_times)
FNR_PH_0.9 = rep(NA, replicate_times)


for (i in 1:replicate_times){
  # Beta
  Beta_true <- simulated_results[,i]$Beta_true
  Beta_est_bSplines_0.1[i, ] <- simulated_results[,i]$Beta_bSplines_0.1
  Beta_est_bSplines_0.4[i, ] <- simulated_results[,i]$Beta_bSplines_0.4
  Beta_est_bSplines_0.9[i, ] <- simulated_results[,i]$Beta_bSplines_0.9
  
  Beta_est_PH_0.1[i, ] <-  simulated_results[,i]$Beta_PH_0.1
  Beta_est_PH_0.4[i, ] <-  simulated_results[,i]$Beta_PH_0.4
  Beta_est_PH_0.9[i, ] <-  simulated_results[,i]$Beta_PH_0.9
  
  # MSE
  MSEs_bSplines_0.1_[i, ] <- (simulated_results[,i]$Beta_bSplines_0.1 - Beta_true)**2
  MSEs_bSplines_0.4_[i, ] <- (simulated_results[,i]$Beta_bSplines_0.4 - Beta_true)**2
  MSEs_bSplines_0.9_[i, ] <- (simulated_results[,i]$Beta_bSplines_0.9 - Beta_true)**2
  MSEs_PH_0.1_[i, ] <- (simulated_results[,i]$Beta_PH_0.1 - Beta_true)**2
  MSEs_PH_0.4_[i, ] <- (simulated_results[,i]$Beta_PH_0.4 - Beta_true)**2
  MSEs_PH_0.9_[i, ] <- (simulated_results[,i]$Beta_PH_0.9 - Beta_true)**2
  
  # FDR (Type I error)
  variableSelection_reference <- simulated_results[, i]$Beta_true != 0
  
  Selection_bSplines_0.1 <- simulated_results[,i]$varSel_bSplines_0.1
  Selection_bSplines_0.4 <- simulated_results[,i]$varSel_bSplines_0.4
  Selection_bSplines_0.9 <- simulated_results[,i]$varSel_bSplines_0.9

  Selection_PH_0.1 <- simulated_results[,i]$varSel_PH_0.1
  Selection_PH_0.4 <- simulated_results[,i]$varSel_PH_0.4
  Selection_PH_0.9 <- simulated_results[,i]$varSel_PH_0.9
  

  FDR_bSplines_0.1[i] <- sum(Selection_bSplines_0.1 & !variableSelection_reference) / sum(Selection_bSplines_0.1)
  FDR_bSplines_0.4[i] <- sum(Selection_bSplines_0.4 & !variableSelection_reference) / sum(Selection_bSplines_0.4)
  FDR_bSplines_0.9[i] <- sum(Selection_bSplines_0.9 & !variableSelection_reference) / sum(Selection_bSplines_0.9)
  FDR_PH_0.1[i] <- sum(Selection_PH_0.1 & !variableSelection_reference) / sum(Selection_PH_0.1)
  FDR_PH_0.4[i] <- sum(Selection_PH_0.4 & !variableSelection_reference) / sum(Selection_PH_0.4)
  FDR_PH_0.9[i] <- sum(Selection_PH_0.9 & !variableSelection_reference) / sum(Selection_PH_0.9)
  
  
  # Number of selected variables (Type II error)
  FNR_bSplines_0.1[i] = sum(!Selection_bSplines_0.1 & variableSelection_reference)/sum(variableSelection_reference)
  FNR_bSplines_0.4[i] = sum(!Selection_bSplines_0.4 & variableSelection_reference)/sum(variableSelection_reference)
  FNR_bSplines_0.9[i] = sum(!Selection_bSplines_0.9 & variableSelection_reference)/sum(variableSelection_reference)
  FNR_PH_0.1[i] = sum(!Selection_PH_0.1 & variableSelection_reference)/sum(variableSelection_reference)
  FNR_PH_0.4[i] = sum(!Selection_PH_0.4 & variableSelection_reference)/sum(variableSelection_reference)
  FNR_PH_0.9[i] = sum(!Selection_PH_0.9 & variableSelection_reference)/sum(variableSelection_reference)
}

# Bias
Bias_bSplines_0.1 = apply(Beta_est_bSplines_0.1, 2, mean) - Beta_true
Bias_bSplines_0.4 = apply(Beta_est_bSplines_0.4, 2, mean) - Beta_true
Bias_bSplines_0.9 = apply(Beta_est_bSplines_0.9, 2, mean) - Beta_true

Bias_PH_0.1 = apply(Beta_est_PH_0.1, 2, mean) - Beta_true
Bias_PH_0.4 = apply(Beta_est_PH_0.4, 2, mean) - Beta_true
Bias_PH_0.9 = apply(Beta_est_PH_0.9, 2, mean) - Beta_true

# Variance 
Variance_bSplines_0.1 = apply(Beta_est_bSplines_0.1, 2, var)
Variance_bSplines_0.4 = apply(Beta_est_bSplines_0.4, 2, var)
Variance_bSplines_0.9 = apply(Beta_est_bSplines_0.9, 2, var)

Variance_PH_0.1 = apply(Beta_est_PH_0.1, 2, var)
Variance_PH_0.4 = apply(Beta_est_PH_0.4, 2, var)
Variance_PH_0.9 = apply(Beta_est_PH_0.9, 2, var)


# MSE
rMSEs_bSplines_0.1 <- sqrt(apply(MSEs_bSplines_0.1_, 2, mean))
rMSEs_bSplines_0.4 <- sqrt(apply(MSEs_bSplines_0.4_, 2, mean))
rMSEs_bSplines_0.9 <- sqrt(apply(MSEs_bSplines_0.9_, 2, mean))
rMSEs_PH_0.1 <- sqrt(apply(MSEs_PH_0.1_, 2, mean))
rMSEs_PH_0.4 <- sqrt(apply(MSEs_PH_0.4_, 2, mean))
rMSEs_PH_0.9 <- sqrt(apply(MSEs_PH_0.9_, 2, mean))

# visualized result
fill_vector = (Beta_true != 0)

par(mfrow = c(3, 2))

# Subfigure 1: Bias
plot(Bias_bSplines_0.1, type = "o", col = "#641e16", xlab = "estimated Betas", ylab = "Bias", main = "Bias for Beta estimation", pch = 16, ylim = c(0, 0.8))

# Add background rectangles
for (i in 1:length(Beta_true)) {
  if (fill_vector[i]) {
    rect(i - 0.5, par("usr")[3], i + 0.5, par("usr")[4], col = "lightblue", border = NA)
  }
}


lines(Bias_bSplines_0.4, type = "o", col = "#c0392b", pch = 16)
lines(Bias_bSplines_0.9, type = "o", col = "#f2d7d5", pch = 16)
lines(Bias_bSplines_0.1, type = "o", col = "#8e1204", pch = 16)
lines(Bias_PH_0.1, type = "o", col = "#145a32", pch = 16)
lines(Bias_PH_0.4, type = "o", col = "#229954", pch = 16)
lines(Bias_PH_0.9, type = "o", col = "#a2d9ce", pch = 16)


abline(v = 10, col = "red", lty = 2)
legend("top", legend = c("bSplines_0.1", "bSplines_0.4", "bSplines_0.9", "PH_0.1", "PH_0.4", "PH_0.9"), col = c("#641e16", "#c0392b", "#f2d7d5", "#145a32", "#229954", "#a2d9ce"), pch = 16, lty = 1,  horiz = TRUE) # Add legend

# Subfigure 2: Variance
plot(Variance_bSplines_0.1, type = "o", col = "#641e16", xlab = "estimated Betas", ylab = "Variance", ylim = c(0, 0.8), main = "Variance for Beta estimation", pch = 16,  horiz = TRUE)

# Add background rectangles
for (i in 1:length(Beta_true)) {
  if (fill_vector[i]) {
    rect(i - 0.5, par("usr")[3], i + 0.5, par("usr")[4], col = "#d5d8dc", border = NA)
  }
}

lines(Variance_bSplines_0.4, type = "o", col = "#c0392b", pch = 16)
lines(Variance_bSplines_0.9, type = "o", col = "#f2d7d5", pch = 16)
lines(Variance_bSplines_0.1, type = "o", col = "#641e16", pch = 16)
lines(Variance_PH_0.1, type = "o", col = "#145a32", pch = 16)
lines(Variance_PH_0.4, type = "o", col = "#229954", pch = 16)
lines(Variance_PH_0.9, type = "o", col = "#a2d9ce", pch = 16)

abline(v = 10, col = "red", lty = 2)
abline(h = 0, col = "red", lty = 2)

legend("top", legend = c("bSplines_0.1", "bSplines_0.4", "bSplines_0.9", "PH_0.1", "PH_0.4", "PH_0.9"), col = c("#641e16", "#c0392b", "#f2d7d5", "#145a32", "#229954", "#a2d9ce"), pch = 16, lty = 1, horiz = TRUE) # Add legend

# Subfigure 3: MSE
plot(rMSEs_bSplines_0.1, type = "o", col = "#641e16", xlab = "estimated Betas", ylab = "rMSE", ylim = c(0, 1), main = "rMSE for Beta estimation", pch = 16)

# Add background rectangles
for (i in 1:length(Beta_true)) {
  if (fill_vector[i]) {
    rect(i - 0.5, par("usr")[3], i + 0.5, par("usr")[4], col = "#d5d8dc", border = NA)
  }
}

lines(rMSEs_bSplines_0.4, type = "o", col = "#c0392b", pch = 16)
lines(rMSEs_bSplines_0.9, type = "o", col = "#f2d7d5", pch = 16)
lines(rMSEs_bSplines_0.1, type = "o", col = "#641e16", pch = 16)
lines(rMSEs_PH_0.1, type = "o", col = "#145a32", pch = 16)
lines(rMSEs_PH_0.4, type = "o", col = "#229954", pch = 16)
lines(rMSEs_PH_0.9, type = "o", col = "#a2d9ce", pch = 16)

abline(v = 10, col = "red", lty = 2)
legend("top", legend = c("bSplines_0.1", "bSplines_0.4", "bSplines_0.9", "PH_0.1", "PH_0.4", "PH_0.9"), col = c("#641e16", "#c0392b", "#f2d7d5", "#145a32", "#229954", "#a2d9ce"), pch = 16, lty = 1, horiz = TRUE) # Add legend


# Subfigure 4 Type I error

FDR_list = list(bSplines_0.1 = FDR_bSplines_0.1, bSplines_0.4 = FDR_bSplines_0.4, bSplines_0.9 = FDR_bSplines_0.9, PH_0.1 = FDR_PH_0.1, PH_0.4 = FDR_PH_0.4, PH_0.9 = FDR_PH_0.9)
boxplot(FDR_list, names = c("bSplines_0.1", "bSplines_0.4", "bSplines_0.9", "PH_0.1", "PH_0.4", "PH_0.9"), col = c("#641e16", "#c0392b", "#f2d7d5", "#145a32", "#229954", "#a2d9ce"), main = "FDR Boxplots", xlab = "", ylab = "FDR")

# Subfigure 5 Type II error
# Create side-by-side boxplots for FDR
Power_list = list(bSplines_0.1 = 1 - FNR_bSplines_0.1, bSplines_0.4 = 1 - FNR_bSplines_0.4, bSplines_0.9 = FNR_bSplines_0.9, 
                         PH_0.1 = 1 - FNR_PH_0.1, PH_0.4 = 1 - FNR_PH_0.4, PH_0.9 = FNR_PH_0.9)
boxplot(Power_list, names = c("bSplines_0.1", "bSplines_0.4", "bSplines_0.9", "PH_0.1", "PH_0.4", "PH_0.9"), col = c("#641e16", "#c0392b", "#f2d7d5", "#145a32", "#229954", "#a2d9ce"), main = "Power", xlab = "", ylab = "Power", ylim = c(0, 1))
```

