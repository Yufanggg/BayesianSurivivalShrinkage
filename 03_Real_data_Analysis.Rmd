---
title: "01_Sim_data_Analysisbaseline"
author: "Yufang Wang"
date: "2025-03-18"
output: pdf_document
---

# Step 1: Set up the environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
setwd("C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#G:/MasterThesis/Code/"
source("./function_file/Functions.R")

install_and_load <- function(packages) {
  for (pkg in packages) {
    if (!require(pkg, character.only = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
    }
    library(pkg, character.only = TRUE) }
  
}

# List of required packages
required_packages <- c("rstan", "MASS", "rstantools", "coda", "readr", "survival", "splines2", "dplyr", "simsurv", "Hmisc", "caret")
# Install and/or load packages
install_and_load(required_packages)
```


# Step 2: Organize the real-world data
```{r, echo=TRUE}
real_df <- readRDS("./Data/preprocessed_NOTR_DGF.rds")
sum(!complete.cases(real_df))
str(real_df)

# get a general idea about the dataset
for (i in 1:ncol(real_df)) { 
  if (is.factor(real_df[[i]])) {
    print(names(real_df)[i])
    print(length(unique(real_df[[i]])))
    }
}


strafied_Data_DBD <- subset(subset(real_df, real_df$TypecadavericDBDDCD == "DBD"), select = -c(TypecadavericDBDDCD))
strafied_Data_DCD <- subset(subset(real_df, real_df$TypecadavericDBDDCD == "DCD"), select = -c(TypecadavericDBDDCD))


includingInter <- function(dataframe_) {
  #sum-coded all factor variables
  factor_var <- sapply(dataframe_, is.factor)
  for (var in names(dataframe_)[factor_var]) {
    if (var != "status") {
      contrasts(dataframe_[[var]]) <- contr.sum(levels(dataframe_[[var]]))
    }
  }
  numeric_var <- sapply(dataframe_, is.numeric)
  for (var in names(dataframe_)[numeric_var]){
    if (var != "time"){
      dataframe_[[var]] <- (dataframe_[[var]] - mean(dataframe_[[var]], na.rm = TRUE)) / sd(dataframe_[[var]], na.rm = TRUE)
    }
    
  }
  
  # lapply(dataframe_[, factor_var], contrasts)
  
  
  # build up interaction effect
  predictors <- subset(dataframe_, select = -c(status, time))
  
  interaction_formula <- as.formula(paste("~ (", paste(colnames(predictors), collapse = " + "), ")^2"))
  interaction_matrix <- model.matrix(interaction_formula, data = dataframe_)
  
  interaction_df <- as.data.frame(interaction_matrix)
  interaction_df <- interaction_df[, -1]
  interaction_df$id = 1:nrow(dataframe_)#dataframe_$ID
  interaction_df$status = ifelse(dataframe_$status == "graftloss", 1, 0)
  interaction_df$obstime = dataframe_$time
  
  return(interaction_df)
}
```


```{r, echo = TRUE}
# only for estimating the Betas
strafied_Data_DBD_int <- includingInter(strafied_Data_DBD)
cor_matrix <- cor(strafied_Data_DBD_int[, sapply(strafied_Data_DBD_int, is.numeric)])
library(corrplot)
# Plot the correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45, 
         addCoef.col = "black", number.cex = 0.7)
```

# estimate the Betas for DBD
```{r, echo=TRUE}
obs_window = 3415 #max(df_using$time_tx_date_max2)
stan_data_bSplines_DBD <- stan_data_Constructer(
      training_dataset = strafied_Data_DBD_int,
      baseline_modelling = "bSplines",
      obs_window = obs_window
    )

model_fit_bSplines_DBD <- Bayesian_Survival_model(stan_data = stan_data_bSplines_DBD, withPrediction = FALSE, baseline_assumption = "bSplines")

#model diagnotics
diagnostics_bSplines_DBD <- summary(model_fit_bSplines_DBD)$summary[, c("Rhat", "n_eff")]

#extract the info from the bayesian model fit
model_result_bSplines_DBD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSplines_DBD, model_type = "bSplines", criteria = c("DesignCoefficients", "baseline", "variableSelection"))


mean_beta_DBD = model_result_bSplines_DBD$Beta_bayesian_est[, "mean"]
FDR_beta_DBD = model_result_bSplines_DBD$variableSelection
```

# estimate the Betas for DCD
```{r, echo=TRUE}
obs_window = 3415 #max(df_using$time_tx_date_max2)
# only for estimating the Betas
strafied_Data_DCD_int <- includingInter(strafied_Data_DCD)
stan_data_bSplines_DCD <- stan_data_Constructer(
      training_dataset = strafied_Data_DCD_int,
      baseline_modelling = "bSplines",
      obs_window = obs_window
    )

model_fit_bSplines_DCD <- Bayesian_Survival_model(stan_data = stan_data_bSplines_DCD, withPrediction = FALSE, baseline_assumption = "bSplines")

#model diagnotics
diagnostics_bSplines_DCD <- summary(model_fit_bSplines_DCD)$summary[, c("Rhat", "n_eff")]

#extract the info from the bayesian model fit
model_result_bSplines_DCD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSplines_DCD, model_type = "bSplines", criteria = c("DesignCoefficients", "baseline", "variableSelection"))


mean_beta_DBD = model_result_bSplines_DCD$Beta_bayesian_est[, "mean"]
FDR_beta_DBD = model_result_bSplines_DCD$variableSelection
```

# Cross-validation for Predictions
```{r, echo=TRUE}
cross_validation <- function(whole_dataset, baseline_modelling = "weibull", num_folds = 5){
  # create the cross-validation folds
  folds <- createFolds(whole_dataset$status, k = num_folds, list = TRUE, returnTrain = FALSE)
  cross_val_metric <- list()
  Brier_scores =  rep(NA, 5); C_indices =  rep(NA, 5)
  for (i in 1:num_folds){
    fold_indices <- folds[[i]]
    training_data = whole_dataset[-fold_indices, ]
    testing_data = whole_dataset[fold_indices, ]
    stan_data_bSplines_cv <- stan_data_Constructer(training_dataset = training_data, testing_dataset = testing_data, baseline_modelling = "bSplines", obs_window = obs_window)
    model_fit <- Bayesian_Survival_model(stan_data = stan_data_bSplines_cv, withPrediction = TRUE, baseline_assumption = "bSplines")
    #extract the info from the bayesian model fit
    model_result <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit)
    
    #model diagnotics
    diagnostics_bSplines <- summary(model_fit_bSplines)$summary[, c("Rhat", "n_eff")]
    disp("The covergence for", i)
    print(diagnostics_bSplines)
    
    #extract the info from the bayesian model fit
    model_result_bSplines <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSplines, model_type = "bSplines", criteria = "Prediction_SurvivalProb")
    
    Brier_scores[i] <- model_metric$Brier_score
    C_indices[i] <- model_metric$C_index
  }
  cross_val_metric$Brier_scores <- Brier_scores
  cross_val_metric$C_indices <- C_indices
  return(cross_val_metric)
}

cross_val_metric_DBD <- cross_validation(whole_dataset = strafied_Data_DBD, baseline_modelling = "bSplines") # exponential, weibull, bSplines

cross_val_metric_DCD <- cross_validation(whole_dataset = strafied_Data_DCD, baseline_modelling = "bSplines") # exponential, weibull, bSplines
```

