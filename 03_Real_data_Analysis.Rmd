---
title: "03_Real_Data_Analysis"
author: "Yufang Wang"
date: "2025-03-18"
output: pdf_document
---

# Step 1: Set up the environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
setwd("C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#G:/MasterThesis/Code/"
source("./function_file/Functions.R")
source("./function_file/stan_constructor.R")

install_and_load <- function(packages) {
  for (pkg in packages) {
    if (!require(pkg, character.only = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
    }
    library(pkg, character.only = TRUE) }
  
}

# List of required packages
required_packages <- c("rstan", "MASS", "rstantools", "coda", "readr", "survival", "splines2", "dplyr", "simsurv", "Hmisc", "caret", "corrplot","ggplot2")
# Install and/or load packages
install_and_load(required_packages)
```


# Step 2: Organize the real-world data
```{r, echo=TRUE}
real_df <- readRDS("./Data/imputed_NOTR_DGF.rds")
sum(!complete.cases(real_df))
mean(real_df$status == "graftloss")
mean(real_df$status == "alive")
mean(real_df$status == "death")

# Reversed KM for follow-up analysis
fit <- survfit(Surv(real_df$time, real_df$status != "graftloss") ~ 1)
plot(fit)
abline(h = 0.5, col = "red", lty = 2)

str(real_df)
real_df <- real_df[, !names(real_df) %in% "ID"]

# get a general idea about the dataset
for (i in 1:ncol(real_df)) { 
  if (is.factor(real_df[[i]])) {
    print(names(real_df)[i])
    print(length(unique(real_df[[i]])))
    }
}
factorName <- sapply(real_df, is.factor)
factorName["status"] <- FALSE

print(colnames(real_df)[factorName])

real_df <- real_df[, !(names(real_df) %in% "InitialOnmachineindicator")]
real_df$Donorcauseofdeath_group <- ifelse(real_df$Donorcauseofdeath_group == "Cardiac", "Cardiac", "Others")
real_df$InitialPrimaryDiseaseET_regroup <- ifelse(real_df$InitialPrimaryDiseaseET_regroup == "Diabetes Mellitus", "Diabetes", "Others")

strafied_Data_DBD <- subset(subset(real_df, real_df$TypecadavericDBDDCD == "DBD"), select = -c(TypecadavericDBDDCD, Warm_ischaemic_period_1))

strafied_Data_DCD <- subset(subset(real_df, real_df$TypecadavericDBDDCD == "DCD"), select = -c(TypecadavericDBDDCD))
```


```{r, echo=TRUE}
includingInter <- function(dataframe_) {
  #sum-coded all factor variables
  factor_var <- sapply(dataframe_, is.factor)
  for (var in names(dataframe_)[factor_var]) {
    if (var != "status") {
      contrasts(dataframe_[[var]]) <- contr.sum(levels(dataframe_[[var]]))
    }
  }
  numeric_var <- sapply(dataframe_, is.numeric)
  for (var in names(dataframe_)[numeric_var]){
    if (var != "time"){
      dataframe_[[var]] <- (dataframe_[[var]] - mean(dataframe_[[var]], na.rm = TRUE)) / sd(dataframe_[[var]], na.rm = TRUE)
    }
    
  }
  
  # print(colnames(dataframe_)[numeric_var])
  
  # build up interaction effect
  predictors <- subset(dataframe_, select = -c(status, time))
  
  interaction_formula <- as.formula(paste("~ (", paste(colnames(predictors), collapse = " + "), ")^2"))
  interaction_matrix <- model.matrix(interaction_formula, data = dataframe_)
  
  interaction_df <- as.data.frame(interaction_matrix)
  interaction_df <- interaction_df[, -1]
  
# Exclude interactions involving categorical variables
  all_terms <- colnames(interaction_df)
  interaction_terms <- all_terms[grepl(":", all_terms)]
  # print(interaction_terms)
  factor_vars <- c("Recipientsex", "Donorsex", "Smoking", "InitialOnmachineindicator", "status", "InitialPrimaryDiseaseET_regroup", "Donorcauseofdeath_group")#colnames(dataframe_)[factor_var]
  # print(factor_vars)
  
  exclude_terms <- sapply(interaction_terms, function(term) {
    terms_ <- unlist(strsplit(term, ":"))
    Con1 <- any(agrepl(terms_[1], factor_vars))
    Con2 <- any(agrepl(terms_[2], factor_vars))
    if ((Con2 | Con1)){
      Con1 = agrepl(terms_[1], "InitialPrimaryDiseaseET_regroup")
      Con2 = agrepl(terms_[2], "InitialPrimaryDiseaseET_regroup")

      return(any(Con1, Con2))
      # print(terms_[2])
      # print(Con2)
    }
    # print(term)
    # print(all(Con1, Con2))
    return(all(Con1, Con2))
  })
  
  # print(exclude_terms)
  exclude_columns <- interaction_terms[exclude_terms]
  selected_columns <- setdiff(all_terms, exclude_columns)
  interaction_df <- subset(interaction_df, select = selected_columns)
  interaction_df$id = 1:nrow(dataframe_)#dataframe_$ID
  interaction_df$status = ifelse(dataframe_$status == "graftloss", 1, 0)
  interaction_df$obstime = dataframe_$time


  # print(interaction_terms[exclude_terms])

  
  return(interaction_df)
}
```
# Section 1: Data analysis for DBD
## Step 1: EDA -have a look at the correlation for DBD
```{r, echo = TRUE}
# only for estimating the Betas
strafied_Data_DBD_int <- includingInter(strafied_Data_DBD)
num_strafied_Data_DBD_int <- strafied_Data_DBD_int
cor_matrix <- cor(num_strafied_Data_DBD_int)

png(filename = "./Image/correlation_plot.png", width = 6000, height = 6000, res = 300)
par(mar = c(0.1, 0.1, 0.1, 0.1), oma = c(0.1, 0.1, 0.1, 0.1))
corrplot(cor_matrix, method = "color", type = "upper", tl.cex = 0.5, 
         tl.col = "black", cl.cex = 0.5, tl.srt = 45)

# Close the device
dev.off()
```

## Step 1: EDA -have a look at the linear vs. non-linear relationship between variables and the survivial data
```{r, echo=TRUE}

```
## Step 2: estimate the Betas for DBD
```{r, echo=TRUE}
obs_window = 3415 #max(df_using$time_tx_date_max2)
stan_data_bSpline_DBD <- stan_data_Constructer_BSpline(
      training_dataset = strafied_Data_DBD_int,
      testing_dataset = NULL,
      obs_window = 3415
    )

stan_data_PH_DBD <- stan_data_Constructer_PH(
      training_dataset = strafied_Data_DBD_int,
      testing_dataset = NULL
    )

model_fit_bSpline_DBD <- Bayesian_Survival_model(stan_data = stan_data_bSpline_DBD, baseline_modelling = "bSplines", withPrediction = FALSE, shrinkage = TRUE)

model_fit_PH_DBD <- Bayesian_Survival_model(stan_data = stan_data_PH_DBD, baseline_modelling = "none", withPrediction = FALSE, shrinkage = TRUE)

#model diagnotics
diagnostics_bSpline_DBD <- summary(model_fit_bSpline_DBD)$summary[, c("Rhat", "n_eff")]

diagnostics_PH_DBD <- summary(model_fit_PH_DBD)$summary[, c("Rhat", "n_eff")]
print(diagnostics_bSpline_DBD)
print(diagnostics_PH_DBD)

#extract the info from the bayesian model fit
model_result_bSpline_DBD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSpline_DBD, model_type = "none", criteria = c("DesignCoefficients", "baseline", "variableSelection"))

model_result_PH_DBD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_PH_DBD, model_type = "none", criteria = c("DesignCoefficients", "baseline", "variableSelection"))

mean_beta_DBD = model_result_bSpline_DBD$Beta_bayesian_est[, "mean"]
variableSelection_DBD = model_result_bSpline_DBD$variableSelection

mean_beta_DBD_PH = model_result_PH_DBD$Beta_bayesian_est[, "mean"]
variableSelection_DBD_PH = model_result_PH_DBD$variableSelection

#cross_val_metric_DBD <- cross_validation(whole_dataset = strafied_Data_DBD_int, baseline_modelling = "bSplines", num_folds = 5, obs_window = 3415)
save.image(file = "./Data/03_results_DBD.RData")
```

### STEP 3: visualize the results for DBD
```{r, echo=TRUE}
load(file = "./Data/03_results_DBD.RData")
results_DBD_df <- data.frame(variableName = colnames(strafied_Data_DBD_int)[!(colnames(strafied_Data_DBD_int) %in% c("id", "status", "obstime"))],
                             beta_int = mean_beta_DBD, 
                             variableSelection = variableSelection_DBD[,1])

# visualized result
ggplot(results_DBD_df, aes(x = variableName, y = beta_int, color = variableSelection, shape = variableSelection)) + 
  geom_line() + 
  geom_point(size = 3) + 
  theme_minimal() + 
  labs(title = "Estimated Beta", x = "", y = "Estimated Beta") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# # Add background rectangles
# for (i in 1:length(results_DBD_df$variableSelection)) {
#   if (fill_vector[i]) {
#     rect(i - 0.5, par("usr")[3], i + 0.5, par("usr")[4], col = "lightblue", border = NA)
#   }
# }
```

## STEP 2: prediction 

# Section 2: Data analysis for DCD
## STEP 1: estimate the Betas for DCD
```{r, echo=TRUE}
obs_window = 3415 #max(df_using$time_tx_date_max2)
strafied_Data_DCD_int <- includingInter(strafied_Data_DCD)


stan_data_bSpline_DCD <- stan_data_Constructer_BSpline(
      training_dataset = strafied_Data_DCD_int,
      testing_dataset = NULL,
      obs_window = 3415
    )

stan_data_PH_DCD <- stan_data_Constructer_PH(
      training_dataset = strafied_Data_DCD_int,
      testing_dataset = NULL
    )

model_fit_bSpline_DCD <- Bayesian_Survival_model(stan_data = stan_data_bSpline_DCD, baseline_modelling = "bSplines", withPrediction = FALSE, shrinkage = TRUE)

model_fit_PH_DCD <- Bayesian_Survival_model(stan_data = stan_data_PH_DCD, baseline_modelling = "none", withPrediction = FALSE, shrinkage = TRUE)

#model diagnotics
diagnostics_bSpline_DCD <- summary(model_fit_bSpline_DCD)$summary[, c("Rhat", "n_eff")]
diagnostics_PH_DCD <- summary(model_fit_PH_DCD)$summary[, c("Rhat", "n_eff")]
print(diagnostics_bSpline_DCD)
print(diagnostics_PH_DCD)

#extract the info from the bayesian model fit
model_result_bSpline_DCD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSpline_DCD, model_type = "none", criteria = c("DesignCoefficients", "baseline", "variableSelection"))

model_result_PH_DCD <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_PH_DCD, model_type = "none", criteria = c("DesignCoefficients", "baseline", "variableSelection"))

mean_beta_DCD = model_result_bSpline_DCD$Beta_bayesian_est[, "mean"]
variableSelection_DCD = model_result_bSpline_DCD$variableSelection

mean_beta_DCD_PH = model_result_PH_DCD$Beta_bayesian_est[, "mean"]
variableSelection_DCD_PH = model_result_PH_DCD$variableSelection

#cross_val_metric_DBD <- cross_validation(whole_dataset = strafied_Data_DBD_int, baseline_modelling = "bSplines", num_folds = 5, obs_window = 3415)
save.image(file = "./Data/03_results_DCD.RData")
```



