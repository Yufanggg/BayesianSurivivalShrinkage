# Install and/or load packages
install_and_load(required_packages)
source("./function_file/Functions.R")
set.seed(123)
n_samples <- 300
n_features <- 10
# function for one simulation
simulation_bayint_survival <- function(criteria = c("DesignCoefficients", "baseline", "variableSelection", "Prediction_SurvivalProb"), withPrediction = TRUE){
output = list()
simulated_data <- DataGenerator(n_samples = n_samples, n_features = 10)
dataset <- simulated_data$dataset
Beta <- simulated_data$Beta
output$Beta_true = Beta
#constructor data for the model
if (withPrediction) {
samples <- sample(1:nrow(dataset), 100)
training_dataset <- dataset[-samples, ]
testing_dataset <- dataset[samples, ]
} else{
training_dataset = dataset
testing_dataset = NULL
}
stan_data_noBSpline <- stan_data_Constructer(
training_dataset = training_dataset,
testing_dataset = testing_dataset,
baseline_modelling = "noBSplines",
partialLiki = TRUE
)
stan_data_bSplines <- stan_data_Constructer(
training_dataset = training_dataset,
testing_dataset = testing_dataset,
baseline_modelling = "bSplines",
obs_window = 5
)
#fit model
model_fit_exponential <-  Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "exponential", shrinkage = TRUE)
model_fit_weibull <- Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "weibull", shrinkage = TRUE)
model_fit_PH <- Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "none", shrinkage = TRUE)
model_fit_bSplines <- Bayesian_Survival_model(stan_data = stan_data_bSplines, baseline_modelling = "bSplines", shrinkage = TRUE)
#collect diagnostics
output$diagnostics_exponential <- summary(model_fit_exponential)$summary[, c("Rhat", "n_eff")]
output$diagnostics_weibull <- summary(model_fit_weibull)$summary[, c("Rhat", "n_eff")]
output$diagnostics_PH <- summary(model_fit_PH)$summary[, c("Rhat", "n_eff")]
output$diagnostics_bSplines <- summary(model_fit_bSplines)$summary[, c("Rhat", "n_eff")]
#extract the info from the bayesian model fit
model_result_exponential <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_exponential, model_type = "exponential", criteria = criteria)
model_result_weibull <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_weibull,  model_type = "weibull", criteria = criteria)
model_result_PH <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_PH,  model_type = "weibull", criteria = criteria)
model_result_bSplines <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSplines, model_type = "bSplines", criteria = criteria)
#---------coefficients for X----------
if ("DesignCoefficients" %in% criteria){
output$Beta_est_exponential = model_result_exponential$Beta_bayesian_est[, "mean"]
output$Beta_est_weibull = model_result_weibull$Beta_bayesian_est[, "mean"]
output$Beta_est_bSplines = model_result_bSplines$Beta_bayesian_est[, "mean"]
output$Beta_est_PH = model_result_PH$Beta_bayesian_est[, "mean"]
}
#----------baseline hazard----------
# Transfer the param into baseline
# hazard function regarding t
#-----------------------------------
if ("baseline" %in% criteria) {
if (withPrediction){
output$time_vec <-
sort(training_dataset[training_dataset$status == 1, ]$obstime) # obs_window = 5
} else {
output$time_vec <-
sort(dataset[dataset$status == 1, ]$obstime) # obs_window = 5
}
output$baseline_true <-  10 * 2 * (output$time_vec  ** (10 - 1))
output$baseline_exponential <-
rep(model_result_exponential$baselinePara, length(output$time_vec ))
weibull_lambda <- model_result_weibull$baselinePara[1]
weibull_shape <- model_result_weibull$baselinePara[2]
output$baseline_weibull <-
weibull_shape * weibull_lambda * (output$time_vec  ** (weibull_shape - 1))
output$baseline_bSplines <-
exp(
as.matrix(stan_data_bSplines$basis) %*% as.matrix(model_result_bSplines$baselinePara[, "mean"])
)
}
if ("variableSelection" %in% criteria) {
output$variableSelection_exponential <-
model_result_exponential$variableSelection
output$variableSelection_weibull <-
model_result_weibull$variableSelection
output$variableSelection_bSplines <-
model_result_bSplines$variableSelection
output$variableSelection_PH <-
model_result_PH$variableSelection
}
if ("Prediction_SurvivalProb" %in% criteria) {
output$time = testing_dataset$obstime
output$true_status = testing_dataset$status
output$eta_true = as.vector(as.matrix(stan_data_noBSpline$x_new) %*% output$Beta_true[1:10] + as.matrix(stan_data_noBSpline$x_int_new) %*% output$Beta_true[11:55])
output$eta_pred_exponential = model_result_exponential$eta_pred
output$eta_pred_weibulll = model_result_weibull$eta_pred
output$eta_pred_bSplines = model_result_bSplines$eta_pred
output$eta_pred_bSplines = model_result_PH$eta_pred
output$sp_exponential = model_result_exponential$sp
output$sp_weibull = model_result_weibull$sp
output$sp_bSplines = model_result_bSplines$sp
}
return(output)
}
replicate_times = 2
simulated_results <- replicate(replicate_times, simulation_bayint_survival(), simplify = "array")
#save.image(file = "./Data/sim_50_para_int_PH.RData")
# load(file = "./Data/sim_50_para_int.RData")
MSEs_exponential = matrix(nrow = replicate_times, ncol = 55)
MSEs_weibull = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH = matrix(nrow = replicate_times, ncol = 55)
FDR_exponential = rep(NA, replicate_times)
FDR_weibull = rep(NA, replicate_times)
FDR_bSplines = rep(NA, replicate_times)
FDR_PH = rep(NA, replicate_times)
CI_index_exponential = rep(NA, replicate_times)
CI_index_weibull = rep(NA, replicate_times)
CI_index_bSplines = rep(NA, replicate_times)
CI_index_PH = rep(NA, replicate_times)
cor_exponential = rep(NA, replicate_times)
cor_weibull = rep(NA, replicate_times)
cor_bSplines = rep(NA, replicate_times)
cor_PH = rep(NA, replicate_times)
cor_sp_exponential = rep(NA, replicate_times)
cor_sp_weibull = rep(NA, replicate_times)
cor_sp_bSplines = rep(NA, replicate_times)
for (i in 1:replicate_times){
# beta MSE
Beta_true <- simulated_results[,i]$Beta_true
Beta_est_exponential <- simulated_results[,i]$Beta_est_exponential
Beta_est_weibull <- simulated_results[,i]$Beta_est_weibull
Beta_est_bSplines <-  simulated_results[,i]$Beta_est_bSplines
MSEs_exponential[i, ] <- (Beta_est_exponential - Beta_true)**2
MSEs_weibull[i, ] <- (Beta_est_weibull - Beta_true)**2
MSEs_bSplines[i, ] <- (Beta_est_bSplines - Beta_true)**2
# FDR
variableSelection_reference <- ifelse(simulated_results[,i]$Beta_true != 0, TRUE, FALSE)
Selection_exponential <- simulated_results[,i]$variableSelection_exponential
Selection_weibull <- simulated_results[,i]$variableSelection_weibull
Selection_bSplines <- simulated_results[,i]$variableSelection_bSplines
FDR_exponential[i] <- sum(Selection_exponential & !variableSelection_reference) / sum(Selection_exponential)
FDR_weibull[i] <- sum(Selection_weibull & !variableSelection_reference) / sum(Selection_weibull)
FDR_bSplines[i] <- sum(Selection_bSplines & !variableSelection_reference) / sum(Selection_bSplines)
#linear predictor
eta_true <- simulated_results[,i]$eta_true
eta_pre_exponential <- simulated_results[, i]$eta_pred_exponential
eta_pre_weibull <- simulated_results[, i]$eta_pred_weibulll
eta_pre_bSplines <- simulated_results[, i]$eta_pred_bSplines
sp_pre_exponential <- simulated_results[,i]$sp_exponential
sp_pre_weibull <- simulated_results[,i]$sp_weibull
sp_pre_bSplines <- simulated_results[,i]$sp_bSplines
cor_exponential[i] <- cor(eta_true, eta_pre_exponential)
cor_weibull[i] <- cor(eta_true, eta_pre_weibull)
cor_bSplines[i] <- cor(eta_true, eta_pre_bSplines)
# CI
time <- simulated_results[,i]$time
true_status <- simulated_results[,i]$true_status
sp_true <- exp(-2 * time^10 * exp(eta_true))
CI_index_exponential[i] <- rcorr.cens(-eta_pre_exponential, Surv(time, true_status))["C Index"] # rcorr.cens
CI_index_weibull[i] <- rcorr.cens(-eta_pre_weibull, Surv(time, true_status))["C Index"]
CI_index_bSplines[i] <- rcorr.cens(-eta_pre_bSplines, Surv(time, true_status))["C Index"]
cor_sp_exponential[i] <- cor(sp_true, sp_pre_exponential)# rcorr.cens
cor_sp_weibull[i] <- cor(sp_true, sp_pre_weibull)#
cor_sp_bSplines[i] <- cor(sp_true, sp_pre_weibull)#
}
# load(file = "./Data/sim_50_para_int.RData")
MSEs_exponential = matrix(nrow = replicate_times, ncol = 55)
MSEs_weibull = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH = matrix(nrow = replicate_times, ncol = 55)
FDR_exponential = rep(NA, replicate_times)
FDR_weibull = rep(NA, replicate_times)
FDR_bSplines = rep(NA, replicate_times)
FDR_PH = rep(NA, replicate_times)
CI_index_exponential = rep(NA, replicate_times)
CI_index_weibull = rep(NA, replicate_times)
CI_index_bSplines = rep(NA, replicate_times)
CI_index_PH = rep(NA, replicate_times)
cor_exponential = rep(NA, replicate_times)
cor_weibull = rep(NA, replicate_times)
cor_bSplines = rep(NA, replicate_times)
cor_PH = rep(NA, replicate_times)
cor_sp_exponential = rep(NA, replicate_times)
cor_sp_weibull = rep(NA, replicate_times)
cor_sp_bSplines = rep(NA, replicate_times)
for (i in 1:replicate_times){
# beta MSE
Beta_true <- simulated_results[,i]$Beta_true
Beta_est_exponential <- simulated_results[,i]$Beta_est_exponential
Beta_est_weibull <- simulated_results[,i]$Beta_est_weibull
Beta_est_bSplines <-  simulated_results[,i]$Beta_est_bSplines
MSEs_exponential[i, ] <- (Beta_est_exponential - Beta_true)**2
MSEs_weibull[i, ] <- (Beta_est_weibull - Beta_true)**2
MSEs_bSplines[i, ] <- (Beta_est_bSplines - Beta_true)**2
# FDR
variableSelection_reference <- ifelse(simulated_results[,i]$Beta_true != 0, TRUE, FALSE)
Selection_exponential <- simulated_results[,i]$variableSelection_exponential
Selection_weibull <- simulated_results[,i]$variableSelection_weibull
Selection_bSplines <- simulated_results[,i]$variableSelection_bSplines
FDR_exponential[i] <- sum(Selection_exponential & !variableSelection_reference) / sum(Selection_exponential)
FDR_weibull[i] <- sum(Selection_weibull & !variableSelection_reference) / sum(Selection_weibull)
FDR_bSplines[i] <- sum(Selection_bSplines & !variableSelection_reference) / sum(Selection_bSplines)
#linear predictor
eta_true <- simulated_results[,i]$eta_true
eta_pre_exponential <- simulated_results[, i]$eta_pred_exponential
eta_pre_weibull <- simulated_results[, i]$eta_pred_weibulll
eta_pre_bSplines <- simulated_results[, i]$eta_pred_bSplines
sp_pre_exponential <- simulated_results[,i]$sp_exponential
sp_pre_weibull <- simulated_results[,i]$sp_weibull
sp_pre_bSplines <- simulated_results[,i]$sp_bSplines
cor_exponential[i] <- cor(eta_true, eta_pre_exponential)
cor_weibull[i] <- cor(eta_true, eta_pre_weibull)
cor_bSplines[i] <- cor(eta_true, eta_pre_bSplines)
# CI
time <- simulated_results[,i]$time
true_status <- simulated_results[,i]$true_status
sp_true <- exp(-2 * time^10 * exp(eta_true))
CI_index_exponential[i] <- rcorr.cens(-eta_pre_exponential, Surv(time, true_status))["C Index"] # rcorr.cens
CI_index_weibull[i] <- rcorr.cens(-eta_pre_weibull, Surv(time, true_status))["C Index"]
CI_index_bSplines[i] <- rcorr.cens(-eta_pre_bSplines, Surv(time, true_status))["C Index"]
cor_sp_exponential[i] <- cor(sp_true, sp_pre_exponential)# rcorr.cens
cor_sp_weibull[i] <- cor(sp_true, sp_pre_weibull)#
cor_sp_bSplines[i] <- cor(sp_true, sp_pre_bSplines)#
}
MSEs_bSplines
MSEs_weibull
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
setwd("G:/MasterThesis/Code/")#C:/Users/Alisa_Wang/Desktop/MasterThesis/Code/")#G:/MasterThesis/Code/"
install_and_load <- function(packages) {
for (pkg in packages) {
if (!require(pkg, character.only = TRUE)) {
install.packages(pkg, dependencies = TRUE)
}
library(pkg, character.only = TRUE) }
}
# List of required packages
required_packages <- c("rstan", "MASS", "rstantools", "coda", "readr", "survival", "splines2", "dplyr", "simsurv", "Hmisc", "caret", "foreach", "doParallel")
# Install and/or load packages
install_and_load(required_packages)
source("./function_file/Functions.R")
set.seed(123)
n_samples <- 300
n_features <- 10
# function for one simulation
simulation_bayint_survival <- function(criteria = c("DesignCoefficients", "baseline", "variableSelection", "Prediction_SurvivalProb"), withPrediction = TRUE){
output = list()
simulated_data <- DataGenerator(n_samples = n_samples, n_features = 10)
dataset <- simulated_data$dataset
Beta <- simulated_data$Beta
output$Beta_true = Beta
#constructor data for the model
if (withPrediction) {
samples <- sample(1:nrow(dataset), 100)
training_dataset <- dataset[-samples, ]
testing_dataset <- dataset[samples, ]
} else{
training_dataset = dataset
testing_dataset = NULL
}
stan_data_noBSpline <- stan_data_Constructer(
training_dataset = training_dataset,
testing_dataset = testing_dataset,
baseline_modelling = "noBSplines",
partialLiki = TRUE
)
stan_data_bSplines <- stan_data_Constructer(
training_dataset = training_dataset,
testing_dataset = testing_dataset,
baseline_modelling = "bSplines",
obs_window = 5
)
#fit model
model_fit_exponential <-  Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "exponential", shrinkage = TRUE)
model_fit_weibull <- Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "weibull", shrinkage = TRUE)
model_fit_PH <- Bayesian_Survival_model(stan_data = stan_data_noBSpline, withPrediction = TRUE, baseline_modelling = "none", shrinkage = TRUE)
model_fit_bSplines <- Bayesian_Survival_model(stan_data = stan_data_bSplines, baseline_modelling = "bSplines", shrinkage = TRUE)
#collect diagnostics
output$diagnostics_exponential <- summary(model_fit_exponential)$summary[, c("Rhat", "n_eff")]
output$diagnostics_weibull <- summary(model_fit_weibull)$summary[, c("Rhat", "n_eff")]
output$diagnostics_PH <- summary(model_fit_PH)$summary[, c("Rhat", "n_eff")]
output$diagnostics_bSplines <- summary(model_fit_bSplines)$summary[, c("Rhat", "n_eff")]
#extract the info from the bayesian model fit
model_result_exponential <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_exponential, model_type = "exponential", criteria = criteria)
model_result_weibull <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_weibull,  model_type = "weibull", criteria = criteria)
model_result_PH <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_PH,  model_type = "weibull", criteria = criteria)
model_result_bSplines <- Bayesian_Survival_result_Extract(bayesian_model_fit = model_fit_bSplines, model_type = "bSplines", criteria = criteria)
#---------coefficients for X----------
if ("DesignCoefficients" %in% criteria){
output$Beta_est_exponential = model_result_exponential$Beta_bayesian_est[, "mean"]
output$Beta_est_weibull = model_result_weibull$Beta_bayesian_est[, "mean"]
output$Beta_est_bSplines = model_result_bSplines$Beta_bayesian_est[, "mean"]
output$Beta_est_PH = model_result_PH$Beta_bayesian_est[, "mean"]
}
#----------baseline hazard----------
# Transfer the param into baseline
# hazard function regarding t
#-----------------------------------
if ("baseline" %in% criteria) {
if (withPrediction){
output$time_vec <-
sort(training_dataset[training_dataset$status == 1, ]$obstime) # obs_window = 5
} else {
output$time_vec <-
sort(dataset[dataset$status == 1, ]$obstime) # obs_window = 5
}
output$baseline_true <-  10 * 2 * (output$time_vec  ** (10 - 1))
output$baseline_exponential <-
rep(model_result_exponential$baselinePara, length(output$time_vec ))
weibull_lambda <- model_result_weibull$baselinePara[1]
weibull_shape <- model_result_weibull$baselinePara[2]
output$baseline_weibull <-
weibull_shape * weibull_lambda * (output$time_vec  ** (weibull_shape - 1))
output$baseline_bSplines <-
exp(
as.matrix(stan_data_bSplines$basis) %*% as.matrix(model_result_bSplines$baselinePara[, "mean"])
)
}
if ("variableSelection" %in% criteria) {
output$variableSelection_exponential <-
model_result_exponential$variableSelection
output$variableSelection_weibull <-
model_result_weibull$variableSelection
output$variableSelection_bSplines <-
model_result_bSplines$variableSelection
output$variableSelection_PH <-
model_result_PH$variableSelection
}
if ("Prediction_SurvivalProb" %in% criteria) {
output$time = testing_dataset$obstime
output$true_status = testing_dataset$status
output$eta_true = as.vector(as.matrix(stan_data_noBSpline$x_new) %*% output$Beta_true[1:10] + as.matrix(stan_data_noBSpline$x_int_new) %*% output$Beta_true[11:55])
output$eta_pred_exponential = model_result_exponential$eta_pred
output$eta_pred_weibulll = model_result_weibull$eta_pred
output$eta_pred_bSplines = model_result_bSplines$eta_pred
output$eta_pred_bSplines = model_result_PH$eta_pred
output$sp_exponential = model_result_exponential$sp
output$sp_weibull = model_result_weibull$sp
output$sp_bSplines = model_result_bSplines$sp
}
return(output)
}
replicate_times = 2
simulated_results <- replicate(replicate_times, simulation_bayint_survival(), simplify = "array")
#save.image(file = "./Data/sim_50_para_int_PH.RData")
# load(file = "./Data/sim_50_para_int.RData")
MSEs_exponential = matrix(nrow = replicate_times, ncol = 55)
MSEs_weibull = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH = matrix(nrow = replicate_times, ncol = 55)
FDR_exponential = rep(NA, replicate_times)
FDR_weibull = rep(NA, replicate_times)
FDR_bSplines = rep(NA, replicate_times)
FDR_PH = rep(NA, replicate_times)
CI_index_exponential = rep(NA, replicate_times)
CI_index_weibull = rep(NA, replicate_times)
CI_index_bSplines = rep(NA, replicate_times)
CI_index_PH = rep(NA, replicate_times)
cor_exponential = rep(NA, replicate_times)
cor_weibull = rep(NA, replicate_times)
cor_bSplines = rep(NA, replicate_times)
cor_PH = rep(NA, replicate_times)
cor_sp_exponential = rep(NA, replicate_times)
cor_sp_weibull = rep(NA, replicate_times)
cor_sp_bSplines = rep(NA, replicate_times)
for (i in 1:replicate_times){
# beta MSE
Beta_true <- simulated_results[,i]$Beta_true
Beta_est_exponential <- simulated_results[,i]$Beta_est_exponential
Beta_est_weibull <- simulated_results[,i]$Beta_est_weibull
Beta_est_bSplines <-  simulated_results[,i]$Beta_est_bSplines
MSEs_exponential[i, ] <- (Beta_est_exponential - Beta_true)**2
MSEs_weibull[i, ] <- (Beta_est_weibull - Beta_true)**2
MSEs_bSplines[i, ] <- (Beta_est_bSplines - Beta_true)**2
# FDR
variableSelection_reference <- ifelse(simulated_results[,i]$Beta_true != 0, TRUE, FALSE)
Selection_exponential <- simulated_results[,i]$variableSelection_exponential
Selection_weibull <- simulated_results[,i]$variableSelection_weibull
Selection_bSplines <- simulated_results[,i]$variableSelection_bSplines
FDR_exponential[i] <- sum(Selection_exponential & !variableSelection_reference) / sum(Selection_exponential)
FDR_weibull[i] <- sum(Selection_weibull & !variableSelection_reference) / sum(Selection_weibull)
FDR_bSplines[i] <- sum(Selection_bSplines & !variableSelection_reference) / sum(Selection_bSplines)
#linear predictor
eta_true <- simulated_results[,i]$eta_true
eta_pre_exponential <- simulated_results[, i]$eta_pred_exponential
eta_pre_weibull <- simulated_results[, i]$eta_pred_weibulll
eta_pre_bSplines <- simulated_results[, i]$eta_pred_bSplines
sp_pre_exponential <- simulated_results[,i]$sp_exponential
sp_pre_weibull <- simulated_results[,i]$sp_weibull
sp_pre_bSplines <- simulated_results[,i]$sp_bSplines
cor_exponential[i] <- cor(eta_true, eta_pre_exponential)
cor_weibull[i] <- cor(eta_true, eta_pre_weibull)
cor_bSplines[i] <- cor(eta_true, eta_pre_bSplines)
# CI
time <- simulated_results[,i]$time
true_status <- simulated_results[,i]$true_status
sp_true <- exp(-2 * time^10 * exp(eta_true))
CI_index_exponential[i] <- rcorr.cens(-eta_pre_exponential, Surv(time, true_status))["C Index"] # rcorr.cens
CI_index_weibull[i] <- rcorr.cens(-eta_pre_weibull, Surv(time, true_status))["C Index"]
CI_index_bSplines[i] <- rcorr.cens(-eta_pre_bSplines, Surv(time, true_status))["C Index"]
cor_sp_exponential[i] <- cor(sp_true, sp_pre_exponential)# rcorr.cens
cor_sp_weibull[i] <- cor(sp_true, sp_pre_weibull)#
cor_sp_bSplines[i] <- cor(sp_true, sp_pre_bSplines)#
}
# load(file = "./Data/sim_50_para_int.RData")
MSEs_exponential = matrix(nrow = replicate_times, ncol = 55)
MSEs_weibull = matrix(nrow = replicate_times, ncol = 55)
MSEs_bSplines = matrix(nrow = replicate_times, ncol = 55)
MSEs_PH = matrix(nrow = replicate_times, ncol = 55)
FDR_exponential = rep(NA, replicate_times)
FDR_weibull = rep(NA, replicate_times)
FDR_bSplines = rep(NA, replicate_times)
FDR_PH = rep(NA, replicate_times)
CI_index_exponential = rep(NA, replicate_times)
CI_index_weibull = rep(NA, replicate_times)
CI_index_bSplines = rep(NA, replicate_times)
CI_index_PH = rep(NA, replicate_times)
cor_exponential = rep(NA, replicate_times)
cor_weibull = rep(NA, replicate_times)
cor_bSplines = rep(NA, replicate_times)
cor_PH = rep(NA, replicate_times)
cor_sp_exponential = rep(NA, replicate_times)
cor_sp_weibull = rep(NA, replicate_times)
cor_sp_bSplines = rep(NA, replicate_times)
for (i in 1:replicate_times){
# beta MSE
Beta_true <- simulated_results[,i]$Beta_true
Beta_est_exponential <- simulated_results[,i]$Beta_est_exponential
Beta_est_weibull <- simulated_results[,i]$Beta_est_weibull
Beta_est_bSplines <-  simulated_results[,i]$Beta_est_bSplines
MSEs_exponential[i, ] <- (Beta_est_exponential - Beta_true)**2
MSEs_weibull[i, ] <- (Beta_est_weibull - Beta_true)**2
MSEs_bSplines[i, ] <- (Beta_est_bSplines - Beta_true)**2
# FDR
variableSelection_reference <- ifelse(simulated_results[,i]$Beta_true != 0, TRUE, FALSE)
Selection_exponential <- simulated_results[,i]$variableSelection_exponential
Selection_weibull <- simulated_results[,i]$variableSelection_weibull
Selection_bSplines <- simulated_results[,i]$variableSelection_bSplines
FDR_exponential[i] <- sum(Selection_exponential & !variableSelection_reference) / sum(Selection_exponential)
FDR_weibull[i] <- sum(Selection_weibull & !variableSelection_reference) / sum(Selection_weibull)
FDR_bSplines[i] <- sum(Selection_bSplines & !variableSelection_reference) / sum(Selection_bSplines)
#linear predictor
eta_true <- simulated_results[,i]$eta_true
eta_pre_exponential <- simulated_results[, i]$eta_pred_exponential
eta_pre_weibull <- simulated_results[, i]$eta_pred_weibulll
eta_pre_bSplines <- simulated_results[, i]$eta_pred_bSplines
sp_pre_exponential <- simulated_results[,i]$sp_exponential
sp_pre_weibull <- simulated_results[,i]$sp_weibull
sp_pre_bSplines <- simulated_results[,i]$sp_bSplines
cor_exponential[i] <- cor(eta_true, eta_pre_exponential)
cor_weibull[i] <- cor(eta_true, eta_pre_weibull)
cor_bSplines[i] <- cor(eta_true, eta_pre_bSplines)
# CI
time <- simulated_results[,i]$time
true_status <- simulated_results[,i]$true_status
sp_true <- exp(-2 * time^10 * exp(eta_true))
CI_index_exponential[i] <- rcorr.cens(-eta_pre_exponential, Surv(time, true_status))["C Index"] # rcorr.cens
CI_index_weibull[i] <- rcorr.cens(-eta_pre_weibull, Surv(time, true_status))["C Index"]
CI_index_bSplines[i] <- rcorr.cens(-eta_pre_bSplines, Surv(time, true_status))["C Index"]
# cor_sp_exponential[i] <- cor(sp_true, sp_pre_exponential)# rcorr.cens
# cor_sp_weibull[i] <- cor(sp_true, sp_pre_weibull)#
# cor_sp_bSplines[i] <- cor(sp_true, sp_pre_bSplines)#
}
i= 1
# beta MSE
Beta_true <- simulated_results[,i]$Beta_true
Beta_est_exponential <- simulated_results[,i]$Beta_est_exponential
Beta_est_weibull <- simulated_results[,i]$Beta_est_weibull
Beta_est_bSplines <-  simulated_results[,i]$Beta_est_bSplines
MSEs_exponential[i, ] <- (Beta_est_exponential - Beta_true)**2
MSEs_weibull[i, ] <- (Beta_est_weibull - Beta_true)**2
MSEs_bSplines[i, ] <- (Beta_est_bSplines - Beta_true)**2
# FDR
variableSelection_reference <- ifelse(simulated_results[,i]$Beta_true != 0, TRUE, FALSE)
Selection_exponential <- simulated_results[,i]$variableSelection_exponential
Selection_weibull <- simulated_results[,i]$variableSelection_weibull
Selection_bSplines <- simulated_results[,i]$variableSelection_bSplines
FDR_exponential[i] <- sum(Selection_exponential & !variableSelection_reference) / sum(Selection_exponential)
FDR_weibull[i] <- sum(Selection_weibull & !variableSelection_reference) / sum(Selection_weibull)
FDR_bSplines[i] <- sum(Selection_bSplines & !variableSelection_reference) / sum(Selection_bSplines)
#linear predictor
eta_true <- simulated_results[,i]$eta_true
eta_pre_exponential <- simulated_results[, i]$eta_pred_exponential
eta_pre_weibull <- simulated_results[, i]$eta_pred_weibulll
eta_pre_bSplines <- simulated_results[, i]$eta_pred_bSplines
sp_pre_exponential <- simulated_results[,i]$sp_exponential
sp_pre_weibull <- simulated_results[,i]$sp_weibull
sp_pre_bSplines <- simulated_results[,i]$sp_bSplines
cor_exponential[i] <- cor(eta_true, eta_pre_exponential)
cor_weibull[i] <- cor(eta_true, eta_pre_weibull)
cor_bSplines[i] <- cor(eta_true, eta_pre_bSplines)
# CI
time <- simulated_results[,i]$time
true_status <- simulated_results[,i]$true_status
sp_true <- exp(-2 * time^10 * exp(eta_true))
CI_index_exponential[i] <- rcorr.cens(-eta_pre_exponential, Surv(time, true_status))["C Index"] # rcorr.cens
CI_index_weibull[i] <- rcorr.cens(-eta_pre_weibull, Surv(time, true_status))["C Index"]
CI_index_bSplines[i] <- rcorr.cens(-eta_pre_bSplines, Surv(time, true_status))["C Index"]
mean_MSEs_exponential <- apply(MSEs_exponential, 2, mean)
mean_MSEs_weibull <- apply(MSEs_weibull, 2, mean)
mean_MSEs_bSplines <- apply(MSEs_bSplines, 2, mean)
# visualized result
fill_vector = (simulated_results[, 1]$Beta_true != 0)
par(mfrow = c(3, 2))
plot(mean_MSEs_exponential, type = "o", col = "blue", xlab = "estimated Betas", ylab = "MSE", ylim = c(0, 0.3), main = "MSE for Beta estimation", pch = 16)
# Add background rectangles
for (i in 1:length(mean_MSEs_exponential)) {
if (fill_vector[i]) {
rect(i - 0.5, par("usr")[3], i + 0.5, par("usr")[4], col = "lightblue", border = NA)
}
}
